<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmos Lite</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: monospace; }
        #loading { position: fixed; inset: 0; background: #000; color: #00ffcc; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        #debug { position: absolute; bottom: 10px; left: 10px; color: #00ffcc; font-size: 10px; pointer-events: none; z-index: 2000; }
        .btn { background: #00ffcc; color: #000; border: none; padding: 15px 30px; font-weight: bold; cursor: pointer; border-radius: 5px; }
        video { position: absolute; top: 10px; right: 10px; width: 120px; border: 1px solid #00ffcc; transform: scaleX(-1); }
    </style>
</head>
<body>

<div id="debug">Log: Initializing...</div>
<div id="loading">
    <h2>COSMIC ENGINE</h2>
    <button class="btn" id="start-btn" onclick="startApp()">START ENGINE</button>
    <p id="load-status">Click start to request camera</p>
</div>

<video id="input-video" playsinline></video>

<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const log = (msg) => { document.getElementById('debug').innerText = "Log: " + msg; console.log(msg); };
let scene, camera, renderer, particles, geometry;
let targetPos, currentPos;
const COUNT = 8000; // Reduced for better mobile performance

function initThree() {
    log("Setting up 3D Scene...");
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.z = 15;
    renderer = new THREE.WebGLRenderer({ antialias: false }); // Disable antialias for speed
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    geometry = new THREE.BufferGeometry();
    targetPos = new Float32Array(COUNT * 3);
    currentPos = new Float32Array(COUNT * 3);
    const colors = new Float32Array(COUNT * 3);

    for(let i=0; i<COUNT*3; i++) {
        currentPos[i] = (Math.random()-0.5)*40;
        targetPos[i] = currentPos[i];
        colors[i] = Math.random();
    }

    geometry.setAttribute('position', new THREE.BufferAttribute(currentPos, 3));
    geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
    
    const mat = new THREE.PointsMaterial({ size: 0.1, vertexColors: true, blending: THREE.AdditiveBlending });
    particles = new THREE.Points(geometry, mat);
    scene.add(particles);
    
    animate();
}

function animate() {
    requestAnimationFrame(animate);
    const positions = geometry.attributes.position.array;
    for(let i=0; i<COUNT*3; i++) {
        positions[i] += (targetPos[i] - positions[i]) * 0.1;
    }
    geometry.attributes.position.needsUpdate = true;
    particles.rotation.y += 0.001;
    renderer.render(scene, camera);
}

async function startApp() {
    document.getElementById('load-status').innerText = "Requesting Camera...";
    log("Starting Camera...");
    
    try {
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5 });
        
        hands.onResults((res) => {
            if (res.multiHandLandmarks && res.multiHandLandmarks[0]) {
                const lm = res.multiHandLandmarks[0];
                // Map hand to cosmic center
                const hx = (0.5 - lm[9].x) * 20;
                const hy = (0.5 - lm[9].y) * 15;
                log(`Hand Tracked: ${hx.toFixed(1)}, ${hy.toFixed(1)}`);
                // Simple Gravity effect
                for(let i=0; i<COUNT; i++) {
                    targetPos[i*3] = hx + (Math.random()-0.5)*5;
                    targetPos[i*3+1] = hy + (Math.random()-0.5)*5;
                }
            }
        });

        const videoElement = document.getElementById('input-video');
        const cam = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 480, height: 360
        });

        await cam.start();
        log("Camera Active. Loading 3D...");
        initThree();
        document.getElementById('loading').style.display = 'none';
        
    } catch (e) {
        log("ERROR: " + e.message);
        alert("Launch failed. Ensure you are on HTTPS.");
    }
}
</script>
</body>
</html>
